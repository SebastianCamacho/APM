<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:UI.ViewModels"
             xmlns:converters="clr-namespace:UI.Converters"
             x:Class="UI.Views.PrinterDetailPage"
             Title="Detalle de Impresora"
             x:DataType="viewmodels:PrinterDetailViewModel">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:NumericToStringConverter x:Key="NumericToStringConverter" />
            
            <Style x:Key="EditorInputStyle" TargetType="View">
                <Setter Property="Margin" Value="2" />
            </Style>
            <Style TargetType="Entry">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={DynamicResource Black}, Dark={DynamicResource White}}" />
                <Setter Property="BackgroundColor" Value="Transparent" />
            </Style>
            <Style TargetType="Picker">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="TitleColor" Value="{DynamicResource Gray500}" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={DynamicResource Black}, Dark={DynamicResource White}}" />
                <Setter Property="BackgroundColor" Value="Transparent" />
            </Style>

            <Style x:Key="ButtonOutline" TargetType="Button">
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="BorderColor" Value="{DynamicResource Primary}" />
                <Setter Property="BorderWidth" Value="1" />
                <Setter Property="TextColor" Value="{DynamicResource Primary}" />
                <Setter Property="CornerRadius" Value="8" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto, *, Auto">
        <!-- Header -->
        <Border Grid.Row="0" Padding="10,12" BackgroundColor="{DynamicResource Primary}" StrokeThickness="0">
            <Label Text="Configuración de Impresora" FontSize="16" FontAttributes="Bold" TextColor="{DynamicResource White}" HorizontalOptions="Center" />
        </Border>

        <ScrollView Grid.Row="1" Padding="20">
            <Border StrokeShape="RoundRectangle 12" Padding="20" StrokeThickness="1" Stroke="{DynamicResource Gray200}" BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}" HorizontalOptions="Center" VerticalOptions="Start">
                <VerticalStackLayout Spacing="15" WidthRequest="320">

                    <!-- ID Impresora -->
                    <VerticalStackLayout Spacing="5">
                        <Label Text="ID de Impresora" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Primary}" />
                        <Border StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={DynamicResource Gray600}}" HeightRequest="40">
                            <Entry Text="{Binding Printer.PrinterId}" Placeholder="Ej: ImpresoraCocina" VerticalOptions="Center" Margin="5,0"/>
                        </Border>
                    </VerticalStackLayout>

                    <!-- Tipo de Impresora -->
                    <VerticalStackLayout Spacing="5">
                        <Label Text="Tipo de Impresora" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Primary}" />
                        <Border StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={DynamicResource Gray600}}" HeightRequest="40">
                            <Picker SelectedItem="{Binding SelectedPrinterType}" ItemsSource="{Binding PrinterTypes}" HorizontalOptions="Fill" VerticalOptions="Center" Margin="5,0"/>
                        </Border>
                    </VerticalStackLayout>

                    <!-- Tipo de Conexión -->
                    <VerticalStackLayout Spacing="5">
                        <Label Text="Tipo de Conexión" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Primary}" />
                        <Border StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={DynamicResource Gray600}}" HeightRequest="40">
                            <Picker SelectedItem="{Binding SelectedConnectionType}" ItemsSource="{Binding ConnectionTypes}" HorizontalOptions="Fill" VerticalOptions="Center" Margin="5,0"/>
                        </Border>
                    </VerticalStackLayout>

                    <!-- IP Address (Solo TCP) -->
                    <VerticalStackLayout Spacing="5" IsVisible="{Binding IsTcpConnection}">
                        <Label Text="Dirección IP" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Primary}" />
                        <Grid ColumnDefinitions="*,Auto,*,Auto,*,Auto,*" ColumnSpacing="4">
                            <Border Grid.Column="0" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={DynamicResource Gray600}}" HeightRequest="40">
                                <Entry Text="{Binding IpSegment1}" Keyboard="Numeric" MaxLength="3" HorizontalTextAlignment="Center" VerticalOptions="Center" />
                            </Border>
                            <Label Grid.Column="1" Text="." VerticalOptions="Center" FontAttributes="Bold" />
                            
                            <Border Grid.Column="2" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={DynamicResource Gray600}}" HeightRequest="40">
                                <Entry Text="{Binding IpSegment2}" Keyboard="Numeric" MaxLength="3" HorizontalTextAlignment="Center" VerticalOptions="Center" />
                            </Border>
                            <Label Grid.Column="3" Text="." VerticalOptions="Center" FontAttributes="Bold" />
                            
                            <Border Grid.Column="4" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={DynamicResource Gray600}}" HeightRequest="40">
                                <Entry Text="{Binding IpSegment3}" Keyboard="Numeric" MaxLength="3" HorizontalTextAlignment="Center" VerticalOptions="Center" />
                            </Border>
                            <Label Grid.Column="5" Text="." VerticalOptions="Center" FontAttributes="Bold" />
                            
                            <Border Grid.Column="6" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={DynamicResource Gray600}}" HeightRequest="40">
                                <Entry Text="{Binding IpSegment4}" Keyboard="Numeric" MaxLength="3" HorizontalTextAlignment="Center" VerticalOptions="Center" />
                            </Border>
                        </Grid>
                    </VerticalStackLayout>

                    <!-- Puerto (Solo TCP y si no es Matricial limitada) -->
                    <VerticalStackLayout Spacing="5" IsVisible="{Binding IsTcpConnection}">
                        <Label Text="Puerto" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Primary}" />
                        <Border StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={DynamicResource Gray600}}" HeightRequest="40">
                            <Entry Text="{Binding Printer.Port, Converter={StaticResource NumericToStringConverter}}" Keyboard="Numeric" VerticalOptions="Center" Margin="5,0"/>
                        </Border>
                    </VerticalStackLayout>

                    <!-- Nombre Impresora Local (Solo USB) -->
                    <VerticalStackLayout Spacing="5" IsVisible="{Binding IsUsbConnection}">
                        <Label Text="Nombre Impresora Local (Windows)" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Primary}" />
                        <Border StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={DynamicResource Gray600}}" HeightRequest="40">
                            <Entry Text="{Binding Printer.LocalPrinterName}" Placeholder="Ej: EPSON LX-300+ II" VerticalOptions="Center" Margin="5,0"/>
                        </Border>
                    </VerticalStackLayout>

                    <!-- URI IPP (Solo IPP) -->
                    <VerticalStackLayout Spacing="5" IsVisible="{Binding IsIppConnection}">
                        <Label Text="URI de Impresión (IPP/HTTP)" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Primary}" />
                        <Border StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={DynamicResource Gray600}}" HeightRequest="40">
                            <Entry Text="{Binding ManualUri}" Placeholder="Ej: ipp://192.168.1.50/ipp/print" VerticalOptions="Center" Margin="5,0"/>
                        </Border>
                    </VerticalStackLayout>

                    <!-- Ancho Papel (Solo Térmica o Matricial TCP) -->
                    <VerticalStackLayout Spacing="5" IsVisible="{Binding ShowThermalFields}">
                        <Label Text="Ancho Papel (mm)" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Primary}" />
                        <Border StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={DynamicResource Gray600}}" HeightRequest="40">
                            <Picker SelectedItem="{Binding SelectedPaperWidthMm}" ItemsSource="{Binding AvailablePaperWidths}" HorizontalOptions="Fill" VerticalOptions="Center" Margin="5,0"/>
                        </Border>
                    </VerticalStackLayout>

                    <!-- Switches (Ocultar si es Matricial USB) -->
                    <VerticalStackLayout Spacing="10" Margin="0,5,0,0" IsVisible="{Binding ShowThermalFields}">
                        <Grid ColumnDefinitions="*, Auto">
                            <Label Grid.Column="0" Text="Beep al imprimir" VerticalOptions="Center" FontSize="14" />
                            <Switch Grid.Column="1" IsToggled="{Binding Printer.BeepOnPrint}" />
                        </Grid>
                        
                        <Grid ColumnDefinitions="*, Auto">
                            <Label Grid.Column="0" Text="Abrir cajón al final" VerticalOptions="Center" FontSize="14" />
                            <Switch Grid.Column="1" IsToggled="{Binding Printer.OpenCashDrawerAfterPrint}" />
                        </Grid>
                        
                        <Grid ColumnDefinitions="*, Auto">
                            <Label Grid.Column="0" Text="Abrir cajón sin imprimir" VerticalOptions="Center" FontSize="14" />
                            <Switch Grid.Column="1" IsToggled="{Binding Printer.OpenCashDrawerWithoutPrint}" />
                        </Grid>
                    </VerticalStackLayout>

                </VerticalStackLayout>
            </Border>
        </ScrollView>
        
        <!-- Botones Pie de Página -->
        <Border Grid.Row="2" StrokeThickness="0" Padding="15,10" BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}">
             <Button Text="Guardar Impresora" Command="{Binding SavePrinterCommand}"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}"
                        HeightRequest="42" FontSize="14" CornerRadius="8" />
        </Border>

        <ActivityIndicator Grid.RowSpan="3"
                           IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}"
                           VerticalOptions="Center" HorizontalOptions="Center"
                           Color="{StaticResource Primary}" WidthRequest="50" HeightRequest="50" />
    </Grid>
</ContentPage>