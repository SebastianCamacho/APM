<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:viewmodels="clr-namespace:UI.ViewModels"
             xmlns:models="clr-namespace:AppsielPrintManager.Core.Models;assembly=Core"
             x:Class="UI.Views.TemplateEditorPage"
             Title="Editor de Plantilla"
             x:DataType="viewmodels:TemplateEditorViewModel">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Añadir Sección" Command="{Binding AddSectionCommand}" />
        <ToolbarItem Text="Guardar" Command="{Binding SaveCommand}" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto, *, Auto" Padding="10" Spacing="5">
        <!-- Encabezado Edición -->
        <VerticalStackLayout Grid.Row="0" Spacing="10" Padding="10">
            <Label Text="Configuración General" FontSize="Medium" FontAttributes="Bold" />
            <Entry Placeholder="Nombre de la Plantilla" Text="{Binding TemplateName}" />
            <BoxView HeightRequest="1" Color="{StaticResource Gray200}" Margin="0,5" />
        </VerticalStackLayout>

        <!-- Lista de Secciones -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Sections}" Spacing="15" Padding="5">
                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="viewmodels:TemplateSectionViewModel">
                        <Border StrokeShape="RoundRectangle 12" Padding="15" StrokeThickness="2" Stroke="{StaticResource Gray200}" BackgroundColor="{AppThemeBinding Light=White, Dark=#222}">
                            <VerticalStackLayout Spacing="10">
                                <!-- Cabecera de Sección -->
                                <Grid ColumnDefinitions="*, Auto, Auto, Auto, Auto" ColumnSpacing="8">
                                    <Entry Grid.Column="0" Text="{Binding Name}" FontAttributes="Bold" FontSize="16" Placeholder="Nombre Sección" BorderColor="Transparent" VerticalOptions="Center" />
                                    
                                    <Button Grid.Column="1" Text="↑" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateEditorViewModel}}, Path=MoveUpCommand}" CommandParameter="{Binding .}" WidthRequest="40" HeightRequest="40" Padding="0" CornerRadius="20" />
                                    <Button Grid.Column="2" Text="↓" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateEditorViewModel}}, Path=MoveDownCommand}" CommandParameter="{Binding .}" WidthRequest="40" HeightRequest="40" Padding="0" CornerRadius="20" />
                                    <Button Grid.Column="3" Text="+" Command="{Binding AddElementCommand}" BackgroundColor="Green" WidthRequest="40" HeightRequest="40" Padding="0" CornerRadius="20" />
                                    <Button Grid.Column="4" Text="✕" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateEditorViewModel}}, Path=RemoveSectionCommand}" CommandParameter="{Binding .}" BackgroundColor="DarkRed" WidthRequest="40" HeightRequest="40" Padding="0" CornerRadius="20" />
                                </Grid>

                                <Grid ColumnDefinitions="Auto, *, Auto, *, Auto, 2*" ColumnSpacing="15" Margin="0,5">
                                    <Label Grid.Column="0" Text="Tipo:" VerticalOptions="Center" FontSize="12" TextColor="Gray" />
                                    <Picker Grid.Column="1" ItemsSource="{Binding SectionTypes}" SelectedItem="{Binding Type}" MinimumWidthRequest="100" />
                                    
                                    <Label Grid.Column="2" Text="Alinear:" VerticalOptions="Center" FontSize="12" TextColor="Gray" />
                                    <Picker Grid.Column="3" ItemsSource="{Binding Alignments}" SelectedItem="{Binding Align}" MinimumWidthRequest="100" />
                                    
                                    <Label Grid.Column="4" Text="Origen:" VerticalOptions="Center" FontSize="12" TextColor="Gray" />
                                    <Entry Grid.Column="5" Text="{Binding DataSource}" Placeholder="Ruta datos" />
                                </Grid>

                                <!-- Elementos de la Sección -->
                                <Label Text="Elementos de impresión:" FontSize="13" FontAttributes="Bold" Margin="0,10,0,5" TextColor="{StaticResource Primary}" />
                                <VerticalStackLayout BindableLayout.ItemsSource="{Binding Elements}" Spacing="10" Margin="10,0,0,0">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="viewmodels:TemplateElementViewModel">
                                            <Border StrokeShape="RoundRectangle 8" Padding="12" Stroke="{StaticResource Gray300}" BackgroundColor="{AppThemeBinding Light=#FDFDFD, Dark=#333}">
                                                <VerticalStackLayout Spacing="10">
                                                    <!-- Fila 1: Tipo, Etiqueta y Borrar -->
                                                    <Grid ColumnDefinitions="Auto, *, Auto, 2*, Auto" ColumnSpacing="10">
                                                        <Label Grid.Column="0" Text="Tipo:" VerticalOptions="Center" FontSize="12" FontAttributes="Bold" />
                                                        <Picker Grid.Column="1" ItemsSource="{Binding ElementTypes}" SelectedItem="{Binding Type}" />
                                                        
                                                        <Label Grid.Column="2" Text="Etiqueta:" VerticalOptions="Center" FontSize="12" FontAttributes="Bold" />
                                                        <Entry Grid.Column="3" Text="{Binding Label}" Placeholder="Ej: Cant." />
                                                        
                                                        <Button Grid.Column="4" Text="✕" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateSectionViewModel}}, Path=RemoveElementCommand}" CommandParameter="{Binding .}" BackgroundColor="#CC0000" WidthRequest="36" HeightRequest="36" Padding="0" CornerRadius="18" />
                                                    </Grid>

                                                    <!-- Fila 2: Origen de datos y Alineación -->
                                                    <Grid ColumnDefinitions="Auto, *, Auto, *" ColumnSpacing="10">
                                                        <Label Grid.Column="0" Text="Fuente:" VerticalOptions="Center" FontSize="12" FontAttributes="Bold" />
                                                        <Entry Grid.Column="1" Text="{Binding Source}" Placeholder="Ej: Item.Description" />

                                                        <Label Grid.Column="2" Text="Alineación:" VerticalOptions="Center" FontSize="12" FontAttributes="Bold" />
                                                        <Picker Grid.Column="3" ItemsSource="{Binding Alignments}" SelectedItem="{Binding Align}" />
                                                    </Grid>

                                                    <!-- Fila 3: Tamaño y Formatos (Negrita/Cursiva) -->
                                                    <Grid ColumnDefinitions="Auto, *, Auto, Auto, Auto" ColumnSpacing="15" VerticalOptions="Center">
                                                        <Label Grid.Column="0" Text="Tamaño:" VerticalOptions="Center" FontSize="12" FontAttributes="Bold" />
                                                        <Picker Grid.Column="1" ItemsSource="{Binding Sizes}" SelectedIndex="{Binding SelectedSizeIdx}" />
                                                        
                                                        <HorizontalStackLayout Grid.Column="2" VerticalOptions="Center" Spacing="2">
                                                            <CheckBox IsChecked="{Binding IsBold}" Color="{StaticResource Primary}" />
                                                            <Label Text="Negrita" VerticalOptions="Center" />
                                                        </HorizontalStackLayout>

                                                        <HorizontalStackLayout Grid.Column="3" VerticalOptions="Center" Spacing="2">
                                                            <CheckBox IsChecked="{Binding IsItalic}" Color="{StaticResource Primary}" />
                                                            <Label Text="Cursiva" VerticalOptions="Center" />
                                                        </HorizontalStackLayout>
                                                    </Grid>
                                                </VerticalStackLayout>
                                            </Border>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </VerticalStackLayout>
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Botones de Acción -->
        <Grid Grid.Row="2" ColumnDefinitions="*, *" ColumnSpacing="15" Padding="15">
            <Button Grid.Column="0" Text="Cancelar" Command="{Binding CancelCommand}" Style="{StaticResource ButtonOutline}" HeightRequest="50" />
            <Button Grid.Column="1" Text="Guardar Plantilla" Command="{Binding SaveCommand}" HeightRequest="50" />
        </Grid>


        <ActivityIndicator Grid.RowSpan="3" IsRunning="{Binding IsBusy}" VerticalOptions="Center" HorizontalOptions="Center" />
    </Grid>
</ContentPage>
