<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:viewmodels="clr-namespace:UI.ViewModels"
             xmlns:models="clr-namespace:AppsielPrintManager.Core.Models;assembly=Core"
             x:Class="UI.Views.TemplateEditorPage"
             Title="Editor de Plantilla"
             x:DataType="viewmodels:TemplateEditorViewModel">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Style x:Key="EditorInputStyle" TargetType="View">
                <Setter Property="Margin" Value="2" />
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#F0F0F0, Dark=#2A2A2A}" />
            </Style>
            <Style TargetType="Entry" BaseResourceKey="EditorInputStyle">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light=Black, Dark=White}" />
            </Style>
            <Style TargetType="Picker" BaseResourceKey="EditorInputStyle">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="TitleColor" Value="Gray" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light=Black, Dark=White}" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto, *, Auto">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="{OnIdiom Desktop=17.5*, Default=0}" />
            <ColumnDefinition Width="{OnIdiom Desktop=65*, Default=*}" />
            <ColumnDefinition Width="{OnIdiom Desktop=17.5*, Default=0}" />
        </Grid.ColumnDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="3" Padding="{OnIdiom Desktop='20,15', Default='15'}" BackgroundColor="{StaticResource Primary}" StrokeThickness="0">
            <Grid ColumnDefinitions="*, Auto" MaxWidthRequest="{OnIdiom Desktop=1000, Default=-1}">
                <VerticalStackLayout Grid.Column="0">
                    <Label Text="Editor de Plantilla" FontSize="20" FontAttributes="Bold" TextColor="White" />
                    <Entry Text="{Binding Template.Name}" Placeholder="Nombre de la Plantilla" TextColor="White" FontSize="14" BorderColor="Transparent" BackgroundColor="Transparent" />
                </VerticalStackLayout>
                <Button Grid.Column="1" Text="+ Sección" Command="{Binding AddSectionCommand}" VerticalOptions="Center" Style="{StaticResource ButtonOutline}" TextColor="White" BorderColor="White" />
            </Grid>
        </Border>

        <!-- Main Content -->
        <ScrollView Grid.Row="1" Grid.Column="1" Padding="{OnIdiom Desktop='0,10', Default='10'}">
            <VerticalStackLayout Spacing="5">
                    <!-- Encabezado Edición -->
                    <VerticalStackLayout Spacing="10" Padding="0,10">
                        <Label Text="Configuración General" FontSize="Medium" FontAttributes="Bold" />
                        <BoxView HeightRequest="1" Color="{StaticResource Gray200}" Margin="0,5" />
                    </VerticalStackLayout>
                
                    <!-- Lista de Secciones -->
                <VerticalStackLayout BindableLayout.ItemsSource="{Binding Sections}" Spacing="10" Padding="0,5">
                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="viewmodels:TemplateSectionViewModel">
                        <Border StrokeShape="RoundRectangle 12" Padding="12" StrokeThickness="1" Stroke="{StaticResource Gray200}" BackgroundColor="{AppThemeBinding Light=White, Dark=#222}" Margin="0,0,0,10">
                            <VerticalStackLayout Spacing="8">
                                <!-- Cabecera de Sección -->
                                <Grid ColumnDefinitions="*, Auto, Auto, Auto, Auto" ColumnSpacing="6">
                                    <Entry Grid.Column="0" Text="{Binding Name}" FontAttributes="Bold" FontSize="15" Placeholder="Nombre Sección" BorderColor="Transparent" VerticalOptions="Center" />
                                    
                                    <Button Grid.Column="1" Text="↑" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateEditorViewModel}}, Path=MoveUpCommand}" CommandParameter="{Binding .}" WidthRequest="32" HeightRequest="32" Padding="0" CornerRadius="16" FontSize="12" />
                                    <Button Grid.Column="2" Text="↓" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateEditorViewModel}}, Path=MoveDownCommand}" CommandParameter="{Binding .}" WidthRequest="32" HeightRequest="32" Padding="0" CornerRadius="16" FontSize="12" />
                                    <Button Grid.Column="3" Text="+" Command="{Binding AddElementCommand}" BackgroundColor="Green" WidthRequest="32" HeightRequest="32" Padding="0" CornerRadius="16" FontSize="12" />
                                    <Button Grid.Column="4" Text="✕" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateEditorViewModel}}, Path=RemoveSectionCommand}" CommandParameter="{Binding .}" BackgroundColor="DarkRed" WidthRequest="32" HeightRequest="32" Padding="0" CornerRadius="16" FontSize="12" />
                                </Grid>

                                <!-- Configuración de Sección -->
                                <Grid ColumnDefinitions="Auto, *, Auto, *, Auto, 1.5*" ColumnSpacing="10">
                                    <Label Grid.Column="0" Text="Tipo:" VerticalOptions="Center" FontSize="10" TextColor="Gray" />
                                    <Picker Grid.Column="1" ItemsSource="{Binding SectionTypes}" SelectedItem="{Binding Type}" HeightRequest="36" />
                                    
                                    <Label Grid.Column="2" Text="Alinear:" VerticalOptions="Center" FontSize="10" TextColor="Gray" />
                                    <Picker Grid.Column="3" ItemsSource="{Binding Alignments}" SelectedItem="{Binding Align}" HeightRequest="36" />
                                    
                                    <Label Grid.Column="4" Text="Origen:" VerticalOptions="Center" FontSize="10" TextColor="Gray" IsVisible="{Binding IsDataSourceVisible}" />
                                    <Picker Grid.Column="5" ItemsSource="{Binding DisplayDataSourceSuggestions}" SelectedItem="{Binding DataSource}" HeightRequest="36" HorizontalOptions="Fill" IsVisible="{Binding IsDataSourceVisible}" />
                                </Grid>

                                <!-- Formato General de Sección -->
                                <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                    <Label Text="Formato:" VerticalOptions="Center" FontSize="10" TextColor="Gray" />
                                    <Picker ItemsSource="{Binding Sizes}" SelectedIndex="{Binding SelectedSizeIdx}" WidthRequest="100" HeightRequest="32" />
                                    <HorizontalStackLayout VerticalOptions="Center" Spacing="0">
                                        <CheckBox IsChecked="{Binding IsBold}" Scale="0.7" />
                                        <Label Text="N" VerticalOptions="Center" FontAttributes="Bold" Margin="-2,0,8,0" FontSize="11" />
                                    </HorizontalStackLayout>
                                </HorizontalStackLayout>

                                <!-- Elementos de la Sección -->
                                <Label Text="Elementos de impresión:" FontSize="12" FontAttributes="Bold" TextColor="{StaticResource Primary}" Margin="0,2,0,0" />
                                <VerticalStackLayout BindableLayout.ItemsSource="{Binding Elements}" Spacing="6" Margin="5,0,0,0">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="viewmodels:TemplateElementViewModel">
                                            <Border StrokeShape="RoundRectangle 8" Padding="10" Stroke="{StaticResource Gray300}" BackgroundColor="{AppThemeBinding Light=#F9F9F9, Dark=#333}">
                                                <VerticalStackLayout Spacing="8">
                                                    <!-- Fila 1: Elem, Estático, Etiqueta/Valor y Controles -->
                                                    <Grid ColumnDefinitions="Auto, 100, Auto, Auto, Auto, *, Auto, Auto, Auto" ColumnSpacing="4">
                                                        <Label Grid.Column="0" Text="Elem:" VerticalOptions="Center" FontSize="10" FontAttributes="Bold" />
                                                        <Picker Grid.Column="1" ItemsSource="{Binding ElementTypes}" SelectedItem="{Binding Type}" HeightRequest="36" />
                                                        
                                                        <Label Grid.Column="2" Text="Fijo:" VerticalOptions="Center" FontSize="10" IsVisible="{Binding ShowStaticToggle}" />
                                                        <CheckBox Grid.Column="3" IsChecked="{Binding IsStatic}" Scale="0.7" IsVisible="{Binding ShowStaticToggle}" />

                                                        <Label Grid.Column="4" Text="Etiq:" VerticalOptions="Center" FontSize="10" FontAttributes="Bold" IsVisible="{Binding ShowLabelAndSource}" />
                                                        <Entry Grid.Column="5" Text="{Binding Label}" Placeholder="Ej: Cant." HeightRequest="36" IsVisible="{Binding ShowLabelAndSource}" />

                                                        <Label Grid.Column="4" Text="Valor:" VerticalOptions="Center" FontSize="10" FontAttributes="Bold" IsVisible="{Binding ShowStaticValueInput}" />
                                                        <Entry Grid.Column="5" Text="{Binding StaticValue}" Placeholder="Texto fijo..." HeightRequest="36" IsVisible="{Binding ShowStaticValueInput}" />
                                                        
                                                        <Button Grid.Column="6" Text="↑" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateSectionViewModel}}, Path=MoveElementUpCommand}" CommandParameter="{Binding .}" WidthRequest="28" HeightRequest="28" Padding="0" CornerRadius="14" FontSize="10" />
                                                        <Button Grid.Column="7" Text="↓" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateSectionViewModel}}, Path=MoveElementDownCommand}" CommandParameter="{Binding .}" WidthRequest="28" HeightRequest="28" Padding="0" CornerRadius="14" FontSize="10" />
                                                        <Button Grid.Column="8" Text="✕" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateSectionViewModel}}, Path=RemoveElementCommand}" CommandParameter="{Binding .}" BackgroundColor="#CC0000" WidthRequest="28" HeightRequest="28" Padding="0" CornerRadius="14" FontSize="10" />
                                                    </Grid>

                                                    <!-- Fila 2: Fuente Unificada -->
                                                    <Grid ColumnDefinitions="Auto, *" ColumnSpacing="8" IsVisible="{Binding ShowLabelAndSource}">
                                                        <Label Grid.Column="0" Text="Fuente:" VerticalOptions="Center" FontSize="10" FontAttributes="Bold" />
                                                        <Picker Grid.Column="1" ItemsSource="{Binding DisplaySuggestions}" SelectedItem="{Binding Source}" HeightRequest="38" HorizontalOptions="Fill" />
                                                    </Grid>

                                                    <!-- Fila 3: Config y Alineación -->
                                                    <Grid ColumnDefinitions="Auto, *, Auto, 120, Auto, Auto" ColumnSpacing="6" VerticalOptions="Center" IsVisible="{Binding IsNotLine}">
                                                        <Label Grid.Column="0" Text="Pos:" VerticalOptions="Center" FontSize="10" />
                                                        <Picker Grid.Column="1" ItemsSource="{Binding Alignments}" SelectedItem="{Binding Align}" HeightRequest="34" />
                                                        
                                                        <Label Grid.Column="2" Text="Txt:" VerticalOptions="Center" FontSize="10" />
                                                        <Picker Grid.Column="3" ItemsSource="{Binding Sizes}" SelectedIndex="{Binding SelectedSizeIdx}" HeightRequest="36" />
                                                        
                                                        <CheckBox Grid.Column="4" IsChecked="{Binding IsBold}" Scale="0.7" />
                                                        <Label Grid.Column="5" Text="N" VerticalOptions="Center" FontAttributes="Bold" Margin="-5,0,0,0" FontSize="10" />
                                                    </Grid>

                                                    <!-- Fila 4: Propiedades Especiales de Tabla (Condicional) -->
                                                    <Grid ColumnDefinitions="Auto, 60, Auto, *, Auto, Auto" ColumnSpacing="6" VerticalOptions="Center" 
                                                          IsVisible="{Binding ShowTableProperties}">
                                                        <Label Grid.Column="0" Text="Ancho%:" VerticalOptions="Center" FontSize="10" TextColor="Gray" />
                                                        <Entry Grid.Column="1" Text="{Binding WidthPercentage}" Keyboard="Numeric" Placeholder="0-100" HeightRequest="32" />
                                                        
                                                        <Label Grid.Column="2" Text="Encab:" VerticalOptions="Center" FontSize="10" TextColor="Gray" />
                                                        <Picker Grid.Column="3" ItemsSource="{Binding Sizes}" SelectedIndex="{Binding SelectedHeaderSizeIdx}" HeightRequest="32" />
                                                        
                                                        <CheckBox Grid.Column="4" IsChecked="{Binding IsHeaderBold}" Scale="0.7" />
                                                        <Label Grid.Column="5" Text="N" VerticalOptions="Center" FontAttributes="Bold" FontSize="9" Margin="-5,0,0,0" />
                                                    </Grid>
                                                </VerticalStackLayout>
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Botones de Acción -->
        <Grid Grid.Row="2" Grid.Column="1" ColumnDefinitions="*, *" ColumnSpacing="15" Padding="{OnIdiom Desktop='0,15', Default='15'}">
            <Button Grid.Column="0" Text="Cancelar" Command="{Binding CancelCommand}" Style="{StaticResource ButtonOutline}" HeightRequest="45" FontSize="13" />
            <Button Grid.Column="1" Text="Guardar Plantilla" Command="{Binding SaveCommand}" HeightRequest="45" FontSize="13" />
        </Grid>

        <ActivityIndicator Grid.RowSpan="3" IsRunning="{Binding IsBusy}" VerticalOptions="Center" HorizontalOptions="Center" />
    </Grid>
</ContentPage>
