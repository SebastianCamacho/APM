<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:viewmodels="clr-namespace:UI.ViewModels"
             xmlns:models="clr-namespace:AppsielPrintManager.Core.Models;assembly=Core"
             x:Class="UI.Views.TemplateEditorPage"
             Title="Editor de Plantilla"
             x:DataType="viewmodels:TemplateEditorViewModel">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Style x:Key="EditorInputStyle" TargetType="View">
                <Setter Property="Margin" Value="2" />
            </Style>
            <Style TargetType="Entry">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={DynamicResource Black}, Dark={DynamicResource White}}" />
                <Setter Property="BackgroundColor" Value="Transparent" />
            </Style>
            <Style TargetType="Picker">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="TitleColor" Value="{DynamicResource Gray500}" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={DynamicResource Black}, Dark={DynamicResource White}}" />
                <Setter Property="BackgroundColor" Value="Transparent" />
            </Style>

            <Style x:Key="ButtonOutline" TargetType="Button">
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="BorderColor" Value="{DynamicResource Primary}" />
                <Setter Property="BorderWidth" Value="1" />
                <Setter Property="TextColor" Value="{DynamicResource Primary}" />
                <Setter Property="CornerRadius" Value="8" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto, *, Auto">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="{OnIdiom Desktop=17.5*, Default=0}" />
            <ColumnDefinition Width="{OnIdiom Desktop=65*, Default=*}" />
            <ColumnDefinition Width="{OnIdiom Desktop=17.5*, Default=0}" />
        </Grid.ColumnDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="3" Padding="{OnIdiom Desktop='20,15', Phone='10,12'}" BackgroundColor="{DynamicResource Primary}" StrokeThickness="0">
            <Grid ColumnDefinitions="*, Auto" MaximumWidthRequest="{OnIdiom Desktop=1000, Default=-1}">
                <VerticalStackLayout Grid.Column="0" Spacing="2">
                    <Label Text="Editor de Plantilla" FontSize="{OnIdiom Desktop=20, Phone=16}" FontAttributes="Bold" TextColor="{DynamicResource White}" />
                    <Border StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="#22FFFFFF" HeightRequest="38">
                        <Entry Text="{Binding Template.Name}" Placeholder="Nombre de la Plantilla" TextColor="{DynamicResource White}" FontSize="{OnIdiom Desktop=14, Phone=12}" BackgroundColor="Transparent" VerticalOptions="Center" />
                    </Border>
                </VerticalStackLayout>
                <Button Grid.Column="1" Text="+ Sección" Command="{Binding AddSectionCommand}" VerticalOptions="Center" Style="{StaticResource ButtonOutline}" TextColor="{DynamicResource White}" BorderColor="{DynamicResource White}" HeightRequest="38" Padding="15,0" />
            </Grid>
        </Border>

        <!-- Main Content -->
        <ScrollView Grid.Row="1" Grid.Column="1" Padding="{OnIdiom Desktop='0,10', Phone='8'}">
            <VerticalStackLayout Spacing="{OnIdiom Desktop=5, Phone=8}">
                    <!-- Encabezado Edición -->
                    <VerticalStackLayout Spacing="5" Padding="0,5">
                        <Label Text="Configuración General" FontSize="{OnIdiom Desktop=Medium, Phone=Basic}" FontAttributes="Bold" />
                        <BoxView HeightRequest="1" Color="{DynamicResource Gray200}" Margin="0,5" />
                    </VerticalStackLayout>
                
                    <!-- Lista de Secciones -->
                <VerticalStackLayout BindableLayout.ItemsSource="{Binding Sections}" Spacing="10" Padding="0,5">
                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="viewmodels:TemplateSectionViewModel">
                        <Border StrokeShape="RoundRectangle 12" Padding="{OnIdiom Desktop=12, Phone=10}" StrokeThickness="1" Stroke="{DynamicResource Gray200}" BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}" Margin="0,0,0,10">
                            <VerticalStackLayout Spacing="8">
                                <!-- Cabecera de Sección -->
                                <Grid ColumnDefinitions="*, Auto, Auto, Auto, Auto" ColumnSpacing="6">
                                    <Border Grid.Column="0" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={DynamicResource Gray600}}" HeightRequest="40">
                                        <Entry Text="{Binding Name}" FontAttributes="Bold" FontSize="{OnIdiom Desktop=15, Phone=14}" Placeholder="Nombre Sección" BackgroundColor="Transparent" VerticalOptions="Center" Margin="5,0" TextColor="{AppThemeBinding Light={DynamicResource Black}, Dark={DynamicResource White}}" />
                                    </Border>
                                    
                                    <Button Grid.Column="1" Text="↑" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateEditorViewModel}}, Path=MoveUpCommand}" CommandParameter="{Binding .}" WidthRequest="32" HeightRequest="32" Padding="0" CornerRadius="16" FontSize="12" BackgroundColor="{DynamicResource Primary}" />
                                    <Button Grid.Column="2" Text="↓" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateEditorViewModel}}, Path=MoveDownCommand}" CommandParameter="{Binding .}" WidthRequest="32" HeightRequest="32" Padding="0" CornerRadius="16" FontSize="12" BackgroundColor="{DynamicResource Primary}" />
                                    <Button Grid.Column="3" Text="+" Command="{Binding AddElementCommand}" BackgroundColor="#2E7D32" WidthRequest="32" HeightRequest="32" Padding="0" CornerRadius="16" FontSize="12" />
                                    <Button Grid.Column="4" Text="✕" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateEditorViewModel}}, Path=RemoveSectionCommand}" CommandParameter="{Binding .}" BackgroundColor="#C62828" WidthRequest="32" HeightRequest="32" Padding="0" CornerRadius="16" FontSize="12" />
                                </Grid>

                                <!-- Configuración de Sección -->
                                <Grid ColumnDefinitions="Auto, *, Auto, *, Auto, 1.5*" ColumnSpacing="{OnIdiom Desktop=10, Phone=5}">
                                    <Label Grid.Column="0" Text="Tipo:" VerticalOptions="Center" FontSize="10" TextColor="Gray" />
                                    <Border Grid.Column="1" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}" HeightRequest="36">
                                        <Picker ItemsSource="{Binding SectionTypes}" SelectedItem="{Binding Type}" BackgroundColor="Transparent" />
                                    </Border>
                                    
                                    <Label Grid.Column="2" Text="Alinea:" VerticalOptions="Center" FontSize="10" TextColor="Gray" />
                                    <Border Grid.Column="3" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}" HeightRequest="36">
                                        <Picker ItemsSource="{Binding Alignments}" SelectedItem="{Binding Align}" BackgroundColor="Transparent" />
                                    </Border>
                                    
                                    <Label Grid.Column="4" Text="Orig:" VerticalOptions="Center" FontSize="10" TextColor="Gray" IsVisible="{Binding IsDataSourceVisible}" />
                                    <Border Grid.Column="5" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}" HeightRequest="36" IsVisible="{Binding IsDataSourceVisible}">
                                        <Picker ItemsSource="{Binding DisplayDataSourceSuggestions}" SelectedItem="{Binding DataSource}" HorizontalOptions="Fill" BackgroundColor="Transparent" />
                                    </Border>
                                </Grid>

                                <!-- Formato General de Sección -->
                                <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                    <Label Text="Formato:" VerticalOptions="Center" FontSize="10" TextColor="Gray" />
                                    <Border StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}" HeightRequest="32">
                                        <Picker ItemsSource="{Binding Sizes}" SelectedIndex="{Binding SelectedSizeIdx}" WidthRequest="{OnIdiom Desktop=100, Phone=120}" BackgroundColor="Transparent" />
                                    </Border>
                                    <HorizontalStackLayout VerticalOptions="Center" Spacing="0">
                                        <CheckBox IsChecked="{Binding IsBold}" Scale="{OnIdiom Desktop=0.7, Phone=0.9}" />
                                        <Label Text="N" VerticalOptions="Center" FontAttributes="Bold" Margin="-2,0,8,0" FontSize="11" />
                                    </HorizontalStackLayout>
                                </HorizontalStackLayout>

                                <!-- Elementos de la Sección -->
                                <Label Text="Elementos de impresión:" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Primary}" Margin="0,2,0,0" />
                                <VerticalStackLayout BindableLayout.ItemsSource="{Binding Elements}" Spacing="6" Margin="{OnIdiom Desktop='5,0,0,0', Phone='2,0,0,0'}">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="viewmodels:TemplateElementViewModel">
                                            <Border StrokeShape="RoundRectangle 8" Padding="{OnIdiom Desktop=10, Phone=8}" Stroke="{DynamicResource Gray300}" BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}">
                                                <VerticalStackLayout Spacing="8">
                                                    <!-- Fila 1: Tipo y Controles (Acomodados para móvil) -->
                                                    <Grid ColumnDefinitions="{OnIdiom Desktop='Auto, 100, Auto, Auto, Auto, *, Auto, Auto, Auto', Phone='Auto, *, Auto, Auto, Auto'}" 
                                                          RowDefinitions="{OnIdiom Desktop='Auto', Phone='Auto, Auto'}"
                                                          ColumnSpacing="{OnIdiom Desktop=6, Phone=4}" RowSpacing="6">
                                                        
                                                        <!-- Tipo de Elemento -->
                                                        <Label Grid.Row="0" Grid.Column="0" Text="Tipo:" VerticalOptions="Center" FontSize="11" FontAttributes="Bold" />
                                                        <Border Grid.Row="0" Grid.Column="1" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}" HeightRequest="38">
                                                            <Picker ItemsSource="{Binding ElementTypes}" SelectedItem="{Binding Type}" BackgroundColor="Transparent" />
                                                        </Border>
                                                        
                                                        <!-- Botones de Acción (Al final de la fila 0) -->
                                                        <HorizontalStackLayout Grid.Row="0" Grid.Column="{OnIdiom Desktop=6, Phone=2}" Grid.ColumnSpan="{OnIdiom Desktop=3, Phone=3}" Spacing="4" HorizontalOptions="End">
                                                            <Button Text="↑" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateSectionViewModel}}, Path=MoveElementUpCommand}" CommandParameter="{Binding .}" WidthRequest="{OnIdiom Desktop=28, Phone=24}" HeightRequest="{OnIdiom Desktop=28, Phone=24}" Padding="0" CornerRadius="{OnIdiom Desktop=14, Phone=12}" FontSize="10" BackgroundColor="{DynamicResource Primary}" />
                                                            <Button Text="↓" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateSectionViewModel}}, Path=MoveElementDownCommand}" CommandParameter="{Binding .}" WidthRequest="{OnIdiom Desktop=28, Phone=24}" HeightRequest="{OnIdiom Desktop=28, Phone=24}" Padding="0" CornerRadius="{OnIdiom Desktop=14, Phone=12}" FontSize="10" BackgroundColor="{DynamicResource Primary}" />
                                                            <Button Text="✕" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TemplateSectionViewModel}}, Path=RemoveElementCommand}" CommandParameter="{Binding .}" BackgroundColor="#C62828" WidthRequest="{OnIdiom Desktop=28, Phone=24}" HeightRequest="{OnIdiom Desktop=28, Phone=24}" Padding="0" CornerRadius="{OnIdiom Desktop=14, Phone=12}" FontSize="10" />
                                                        </HorizontalStackLayout>

                                                        <!-- Configuración de Fijo/Etiqueta/Valor (Abajo en móvil, centro en Desktop) -->
                                                        <HorizontalStackLayout Grid.Row="{OnIdiom Desktop=0, Phone=1}" Grid.Column="{OnIdiom Desktop=2, Phone=0}" Spacing="4" VerticalOptions="Center" IsVisible="{Binding ShowStaticToggle}">
                                                            <Label Text="Fijo:" VerticalOptions="Center" FontSize="10" />
                                                            <CheckBox IsChecked="{Binding IsStatic}" Scale="{OnIdiom Desktop=0.7, Phone=0.9}" />
                                                        </HorizontalStackLayout>

                                                        <!-- Etiqueta o Valor Dinámico -->
                                                        <Grid Grid.Row="{OnIdiom Desktop=0, Phone=1}" Grid.Column="{OnIdiom Desktop=4, Phone=1}" Grid.ColumnSpan="{OnIdiom Desktop=2, Phone=4}" ColumnDefinitions="Auto, *" ColumnSpacing="4">
                                                            <Label Grid.Column="0" Text="Etiqueta:" VerticalOptions="Center" FontSize="10" FontAttributes="Bold" IsVisible="{Binding ShowLabelAndSource}" />
                                                            <Label Grid.Column="0" Text="Valor:" VerticalOptions="Center" FontSize="10" FontAttributes="Bold" IsVisible="{Binding ShowStaticValueInput}" />
                                                            
                                                            <Border Grid.Column="1" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}" HeightRequest="36" HorizontalOptions="Fill">
                                                                <Entry Text="{Binding Label}" Placeholder="Ej: Cant." FontSize="11" IsVisible="{Binding ShowLabelAndSource}" BackgroundColor="Transparent" />
                                                            </Border>
                                                            <Border Grid.Column="1" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}" HeightRequest="36" HorizontalOptions="Fill" IsVisible="{Binding ShowStaticValueInput}">
                                                                <Entry Text="{Binding StaticValue}" Placeholder="Texto fijo..." FontSize="11" BackgroundColor="Transparent" />
                                                            </Border>
                                                        </Grid>
                                                    </Grid>

                                                    <!-- Fila 2: Fuente Unificada -->
                                                    <Grid ColumnDefinitions="Auto, *" ColumnSpacing="8" IsVisible="{Binding ShowLabelAndSource}">
                                                        <Label Grid.Column="0" Text="Fuente:" VerticalOptions="Center" FontSize="10" FontAttributes="Bold" />
                                                        <Border Grid.Column="1" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}" HeightRequest="38" HorizontalOptions="Fill">
                                                            <Picker ItemsSource="{Binding DisplaySuggestions}" SelectedItem="{Binding Source}" BackgroundColor="Transparent" />
                                                        </Border>
                                                    </Grid>

                                                    <!-- Fila 3: Config y Alineación -->
                                                    <Grid ColumnDefinitions="Auto, *, Auto, 120, Auto, Auto" ColumnSpacing="{OnIdiom Desktop=6, Phone=4}" VerticalOptions="Center" IsVisible="{Binding IsNotLine}">
                                                        <Label Grid.Column="0" Text="Pos:" VerticalOptions="Center" FontSize="10" />
                                                        <Border Grid.Column="1" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}" HeightRequest="34">
                                                            <Picker ItemsSource="{Binding Alignments}" SelectedItem="{Binding Align}" BackgroundColor="Transparent" />
                                                        </Border>
                                                        
                                                        <Label Grid.Column="2" Text="Txt:" VerticalOptions="Center" FontSize="10" />
                                                        <Border Grid.Column="3" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}" HeightRequest="36">
                                                            <Picker ItemsSource="{Binding Sizes}" SelectedIndex="{Binding SelectedSizeIdx}" BackgroundColor="Transparent" />
                                                        </Border>
                                                        
                                                        <CheckBox Grid.Column="4" IsChecked="{Binding IsBold}" Scale="{OnIdiom Desktop=0.7, Phone=0.9}" />
                                                        <Label Grid.Column="5" Text="N" VerticalOptions="Center" FontAttributes="Bold" Margin="-5,0,0,0" FontSize="10" />
                                                    </Grid>

                                                    <!-- Fila 4: Propiedades Especiales de Tabla (Condicional) -->
                                                    <Grid ColumnDefinitions="Auto, 60, Auto, *, Auto, Auto" ColumnSpacing="{OnIdiom Desktop=6, Phone=4}" VerticalOptions="Center" 
                                                          IsVisible="{Binding ShowTableProperties}">
                                                        <Label Grid.Column="0" Text="Ancho%:" VerticalOptions="Center" FontSize="10" TextColor="Gray" />
                                                        <Border Grid.Column="1" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}" HeightRequest="32">
                                                            <Entry Text="{Binding WidthPercentage}" Keyboard="Numeric" Placeholder="0-100" FontSize="11" BackgroundColor="Transparent" />
                                                        </Border>
                                                        
                                                        <Label Grid.Column="2" Text="Enca:" VerticalOptions="Center" FontSize="10" TextColor="Gray" />
                                                        <Border Grid.Column="3" StrokeShape="RoundRectangle 8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}" HeightRequest="32">
                                                            <Picker ItemsSource="{Binding Sizes}" SelectedIndex="{Binding SelectedHeaderSizeIdx}" BackgroundColor="Transparent" />
                                                        </Border>
                                                        
                                                        <CheckBox Grid.Column="4" IsChecked="{Binding IsHeaderBold}" Scale="{OnIdiom Desktop=0.7, Phone=0.9}" />
                                                        <Label Grid.Column="5" Text="N" VerticalOptions="Center" FontAttributes="Bold" FontSize="9" Margin="-5,0,0,0" />
                                                    </Grid>
                                                </VerticalStackLayout>
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </Border>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
                </VerticalStackLayout>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Botones de Acción -->
        <Grid Grid.Row="2" Grid.Column="1" ColumnDefinitions="*, *" ColumnSpacing="15" Padding="{OnIdiom Desktop='0,15', Phone='12'}">
            <Button Grid.Column="0" Text="Cancelar" Command="{Binding CancelCommand}" Style="{StaticResource ButtonOutline}" HeightRequest="{OnIdiom Desktop=45, Phone=42}" FontSize="13" />
            <Button Grid.Column="1" Text="Guardar Plantilla" Command="{Binding SaveCommand}" HeightRequest="{OnIdiom Desktop=45, Phone=42}" FontSize="13" />
        </Grid>

        <!-- Pantalla de Carga Inicial -->
        <Grid Grid.RowSpan="3" Grid.ColumnSpan="3" 
              ZIndex="99"
              BackgroundColor="{AppThemeBinding Light=#AAFFFFFF, Dark=#AA000000}" 
              IsVisible="{Binding IsInitializing}">
            <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="15">
                <ActivityIndicator IsRunning="{Binding IsInitializing}" Color="{DynamicResource Primary}" WidthRequest="60" HeightRequest="60" />
                <Label Text="Preparando editor..." FontAttributes="Bold" HorizontalTextAlignment="Center" TextColor="{DynamicResource Primary}" />
            </VerticalStackLayout>
        </Grid>
 
        <ActivityIndicator Grid.RowSpan="3" Grid.ColumnSpan="3" 
                           ZIndex="100"
                           IsRunning="{Binding IsBusy}" 
                           VerticalOptions="Center" HorizontalOptions="Center" 
                           Color="{DynamicResource Primary}" 
                           WidthRequest="60" HeightRequest="60"/>
    </Grid>
</ContentPage>
