<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Conexión APM WebSocket (Android)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        #status { font-weight: bold; margin-top: 10px; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; margin-top: 20px; background-color: #f9f9f9; }
        .log-info { color: blue; }
        .log-success { color: green; }
        .log-error { color: red; }
        
        /* Estilos para las pestañas */
        .tab-container { margin-top: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; background-color: #ddd; border: none; outline: none; font-weight: bold; }
        .tab-button.active { background-color: #333; color: white; }
        .tab-content { display: none; width: 100%; box-sizing: border-box; }
        .tab-content.active { display: block; }

        /* Estilos para la tabla de facturación */
        #invoiceTable { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #invoiceTable th, #invoiceTable td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        #invoiceTable th { background-color: #f2f2f2; }
        .row-input { width: 100%; padding: 5px; box-sizing: border-box; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>Cliente de Prueba APM WebSocket (Android)</h1>
    
    <div style="background: #eef; padding: 10px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ccd;">
        <label style="font-weight: bold;">URL WebSocket (Cambiar si es necesario):</label><br>
        <input type="text" id="wsUrlOverride" value="ws://localhost:7000/websocket/" style="width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box;">
    </div>

    <p>Estado de la conexión: <span id="status">Desconectado</span></p>
    <button id="reconnectButton" style="margin-top: 10px; padding: 5px 10px;">Reconectar</button>
    <p>Mensajes del Cliente (Auto-scroll al final):</p>
    <div id="messages"></div>

    <hr style="margin: 30px 0;">

    <h2>Prueba de Báscula (Scale Listener)</h2>
    <div style="background-color: #eef; padding: 15px; border-radius: 5px;">
        <label for="scaleIdInput" style="font-weight: bold;">ID Báscula:</label>
        <input type="text" id="scaleIdInput" placeholder="Ej: bascula001" value="bascula001" style="padding: 5px;">
        
        <button id="toggleListeningButton" style="margin-left: 10px; padding: 5px 15px; cursor: pointer; background-color: #4CAF50; color: white; border: none;">Empezar a Escuchar</button>
        
        <div style="margin-top: 15px;">
            <strong>Datos Recibidos:</strong>
            <pre id="scaleDataDisplay" style="background: #fff; border: 1px solid #ccc; padding: 10px; min-height: 50px; font-size: 24px;">Esperando datos...</pre>
        </div>
    </div>
    <hr style="margin: 30px 0;">

    <h2>Enviar Mensaje de Prueba (PrintJobRequest)</h2>
    
    <div class="tab-container">
        <button class="tab-button" data-tab="ticket">Ticket Venta</button>
        <button class="tab-button" data-tab="comanda">Comanda</button>
        <button class="tab-button" data-tab="factura">Factura Electrónica</button>
        <button class="tab-button" data-tab="sticker">Sticker Códigos</button>
    </div>

    <div style="margin-top: 10px;">
        <textarea id="payloadTicket" class="tab-content" rows="15" cols="80"></textarea>
        <textarea id="payloadComanda" class="tab-content" rows="15" cols="80"></textarea>
        <textarea id="payloadFactura" class="tab-content" rows="15" cols="80"></textarea>
        <textarea id="payloadSticker" class="tab-content" rows="15" cols="80"></textarea>
    </div>

    <button id="sendPayloadButton" style="margin-top: 10px; padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; cursor: pointer;">Enviar JSON Seleccionado</button>

    <hr style="margin: 30px 0;">

    <h2>Actualización Remota de Plantillas</h2>
    <p>Envía una nueva definición de plantilla al APM. Requiere confirmación en el dispositivo.</p>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="sendUpdateTemplate('comanda1')" style="padding: 10px; background-color: #6f42c1; color: white; border: none; cursor: pointer;">Comanda (Minimalista)</button>
        <button onclick="sendUpdateTemplate('comanda2')" style="padding: 10px; background-color: #6f42c1; color: white; border: none; cursor: pointer;">Comanda (Detallada)</button>
        <button onclick="sendUpdateTemplate('factura1')" style="padding: 10px; background-color: #e83e8c; color: white; border: none; cursor: pointer;">Factura (Clásica)</button>
        <button onclick="sendUpdateTemplate('factura2')" style="padding: 10px; background-color: #e83e8c; color: white; border: none; cursor: pointer;">Factura (Moderno)</button>
    </div>

    <hr style="margin: 30px 0;">

    <h2>Simulación de Facturación</h2>
    <p>Ingrese códigos (Ej: 1001, 1002, 1003) y haga clic en Cantidad para leer de la báscula.</p>
    
    <button id="addInvoiceRowBtn" style="background-color: #28a745; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px;">+ Agregar Producto</button>
    
    <table id="invoiceTable">
        <thead>
            <tr>
                <th style="width: 15%;">Código</th>
                <th style="width: 30%;">Descripción</th>
                <th style="width: 15%;">Cantidad</th>
                <th style="width: 20%;">Precio Unit.</th>
                <th style="width: 20%;">Total</th>
                <th style="width: 50px;"></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
    // --- main.js INCRUSTADO ---
    let websocketUrl = 'ws://localhost:7000/websocket/';
    let socket;
    const statusSpan = document.getElementById('status');
    const messagesDiv = document.getElementById('messages');
    let activePayloadId = 'payloadTicket';
    let activeQuantityInput = null;

    const productsDb = {
        "1001": { description: "Manzana Royal", price: 12000 },
        "1002": { description: "Pera Importada", price: 14500 },
        "1003": { description: "Banano Criollo", price: 3500 },
        "1004": { description: "Papaya", price: 4000 },
        "1005": { description: "Carne Res", price: 35000 }
    };

    function logMessage(message, type = 'info') {
        const p = document.createElement('p');
        p.className = `log-${type}`;
        p.textContent = message;
        messagesDiv.appendChild(p);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function connectWebSocket() {
        // Soporte para URL personalizada en Android
        const override = document.getElementById('wsUrlOverride');
        if (override) websocketUrl = override.value;

        if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
            logMessage('Ya existe una conexión WebSocket activa o en proceso.', 'warning');
            return;
        }

        statusSpan.textContent = 'Intentando conectar...';
        statusSpan.style.color = 'orange';
        logMessage('Intentando establecer conexión WebSocket con: ' + websocketUrl, 'info');

        try {
            socket = new WebSocket(websocketUrl);

            socket.onopen = (event) => {
                statusSpan.textContent = 'Conectado';
                statusSpan.style.color = 'green';
                logMessage('Conexión WebSocket establecida con el servidor APM.', 'success');
            };

            socket.onmessage = (event) => {
                logMessage('Mensaje recibido del servidor: ' + event.data);
                try {
                    const data = JSON.parse(event.data);
                    if (data.Weight !== undefined && data.Unit !== undefined) {
                        const display = document.getElementById('scaleDataDisplay');
                        if (display) {
                            display.textContent = `Báscula: ${data.ScaleId}\nPeso: ${data.Weight} ${data.Unit}\nEstable: ${data.Stable}\nTime: ${data.Timestamp}`;
                        }
                        if (activeQuantityInput) {
                            activeQuantityInput.value = data.Weight;
                            calculateRowTotal(activeQuantityInput.closest('tr'));
                        }
                    }
                } catch (e) {}
            };

            socket.onclose = (event) => {
                statusSpan.textContent = 'Desconectado';
                statusSpan.style.color = 'red';
                let reason = event.reason || 'Conexión cerrada inesperadamente.';
                logMessage(`Conexión cerrada. Código: ${event.code}, Razón: ${reason}`, event.wasClean ? 'info' : 'error');
                socket = null;
            };

            socket.onerror = (error) => {
                statusSpan.textContent = 'Error';
                statusSpan.style.color = 'red';
                logMessage('Error en la conexión WebSocket.', 'error');
            };

        } catch (error) {
            logMessage('Error al intentar crear el objeto WebSocket: ' + error.message, 'error');
        }
    }

    function reconnectWebSocket() {
        if (socket) {
            socket.close(1000, 'Reconexión solicitada por el usuario');
        } else {
            connectWebSocket();
        }
    }

    function sendTestMessage(message) {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(message);
            logMessage('Mensaje enviado al servidor: ' + message, 'info');
        } else {
            logMessage('No hay conexión WebSocket abierta para enviar mensajes.', 'warning');
        }
    }

    const templates = {
        ticket: {
            "JobId": "TICKET-001",
            "StationId": "CAJA_1",
            "PrinterId": "printHambuger",
            "DocumentType": "ticket_venta",
            "Document": {
                "company": { "Name": "Supermercado Demo", "Nit": "900123456", "Address": "Calle Principal #123", "Phone": "555-1234" },
                "sale": { 
                    "Number": "FV-1001", 
                    "Date": new Date().toISOString(), 
                    "Items": [
                        { "Name": "Leche Entera", "Qty": 2, "UnitPrice": 2500, "Total": 5000 },
                        { "Name": "Pan Tajado", "Qty": 1, "UnitPrice": 3500, "Total": 3500 }
                    ],
                    "Subtotal": 8500,
                    "IVA": 0,
                    "Total": 8500
                },
                "footer": ["Gracias por su compra"]
            }
        },
        comanda: {
            "JobId": "CMD-001",
            "StationId": "COCINA",
            "PrinterId": "printHambuger",
            "DocumentType": "comanda",
            "Document": {
                "order": { 
                    "COPY":"ORIGINAL",
                    "Number": "CMD-001",
                    "Table": "Mesa 5", 
                    "Waiter": "Carlos", 
                    "Date": new Date().toISOString(),
                    "RestaurantName": "Restaurant Tremendo Chuzo",
                    "Items": [
                        { "Name": "Hamburguesa Doble", "Qty": 1, "Notes": "Sin cebolla" },
                        { "Name": "Papas Fritas", "Qty": 1, "Notes": "Extra crocantes" },
                        { "Name": "Gaseosa", "Qty": 2, "Notes": "" }
                    ],
                    "GeneratedDate": new Date().toISOString(),
                    "CreatedBy": "Jose Reyes"
                },
                "Detail": "Todoterreno sin piña, full arepa sin maíz y la salchipapa sin lechuga"
            }
        },
        factura: {
            "JobId": "FE-2025",
            "StationId": "ADMIN",
            "PrinterId": "printHambuger",
            "DocumentType": "factura_electronica",
            "Document": {
                "Seller": {
                    "Name": "Appsiel S.A.S",
                    "Nit": "900.123.456-7",
                    "TaxRegime": "Responsable de IVA",
                    "Address": "Calle 123 #45-67",
                    "City": "Bogotá, Colombia",
                    "Phone": "300 123 4567",
                    "Email": "facturacion@appsiel.com.co",
                    "ResolutionNumber": "18760000001",
                    "ResolutionDate": "2024-01-01T00:00:00",
                    "ResolutionPrefix": "FE",
                    "ResolutionFrom": "1",
                    "ResolutionTo": "10000",
                    "ResolutionText": "Autorización de Numeración de Facturación Electrónica No. 18760000001 del 2024-01-01 al 2025-01-01 del FE-1 al FE-10000"
                },
                "Buyer": {
                    "Name": "Cliente VIP Ltda",
                    "Nit": "800.987.654-3",
                    "Address": "Carrera 7 #80-20, Bogotá",
                    "Email": "facturacion@clientevip.com"
                },
                "Invoice": {
                    "Number": "FE-9876",
                    "IssueDate": new Date().toISOString(),
                    "DueDate": new Date(new Date().getTime() + 30*24*60*60*1000).toISOString(),
                    "PaymentMethod": "Crédito 30 Días",
                    "PaymentMeans": "Transferencia Bancaria",
                    "Currency": "COP",
                    "Items": [
                        { "Code": "SERV-001", "Description": "Servicio de Consultoría Software", "Quantity": 10, "UnitPrice": 150000, "Discount": 0, "IvaRate": 19, "IvaAmount": 285000, "Total": 1785000 },
                        { "Code": "LIC-005", "Description": "Licencia Anual Appsiel Pro", "Quantity": 1, "UnitPrice": 2500000, "Discount": 250000, "IvaRate": 19, "IvaAmount": 427500, "Total": 2677500 }
                    ],
                    "Subtotal": 3750000, "Discount": 250000, "Iva": 712500, "Total": 4462500,
                    "Taxes": [{ "Name": "IVA 19%", "Base": 3750000, "Rate": 19, "Amount": 712500 }]
                },
                "TechKey": "de30fc14561023a134...",
                "QrString": "https://www.appsiel.com.co/",
                "LegalNotes": ["Esta factura se asimila en todos sus efectos a una letra de cambio (Art. 774 C.Co)", "Régimen Común - Iva Responsable"]
            }
        },
        sticker: {
            "JobId": "STICKER-001",
            "StationId": "ALMACEN",
            "PrinterId": "printHambuger",
            "DocumentType": "sticker_codigo_barras",
            "Document": {
                "stickers": [
                    { "Type": "CODE128", "ItemId": "170", "Name": "BLUSA VERONICA XS", "Price": "$90.000", "Height": 80, "Width": 3, "Hri": false, "Value": "123456" },
                    { "Type": "CODE128", "ItemId": "171", "Name": "PANTALON JEAN 30", "Price": "$120.000", "Height": 40, "Width": 5, "Hri": true, "Value": "654321" }
                ]
            }
        }
    };

    const updateTemplates = {
        comanda1: {
            Action: "UpdateTemplate",
            Template: {
                DocumentType: "comanda",
                Name: "Comanda Minimalista (Actualización)",
                Sections: [
                    {
                        Name: "Encabezado", Type: "Static", Order: 1,
                        Elements: [
                            { Type: "Text", StaticValue: "=== PEDIDO COCINA ===", Format: "Size2 Bold", Align: "Center" },
                            { Type: "Text", Label: "Mesa: ", Source: "order.Table", Format: "Size1", Align: "Left" },
                            { Type: "Line" }
                        ]
                    },
                    {
                        Name: "Items", Type: "Table", DataSource: "order.Items", Order: 2,
                        Elements: [
                            { Type: "Text", Label: "Cant", Source: "Qty", WidthPercentage: 30, Align: "Left" },
                            { Type: "Text", Label: "Producto", Source: "Name", WidthPercentage: 70, Align: "Left" }
                        ]
                    },
                    {
                        Name: "Footer", Type: "Static", Order: 3,
                        Elements: [{ Type: "Text", Label: "NOTAS: ", Source: "order.Notes", Format: "Bold", Align: "Left" }]
                    }
                ]
            }
        },
        comanda2: {
            Action: "UpdateTemplate",
            Template: {
                DocumentType: "comanda",
                Name: "Comanda Detallada (Actualización)",
                Sections: [
                    {
                        Name: "Header", Type: "Static", Order: 1,
                        Elements: [
                            { Type: "Text", Label: "Restaurante: ", Source: "order.RestaurantName", Align: "Center" },
                            { Type: "Text", Label: "Mesero: ", Source: "order.Waiter", Format: "Bold", Align: "Center" },
                            { Type: "Line" }
                        ]
                    },
                    {
                        Name: "Body", Type: "Static", Order: 2,
                        Elements: [
                            { Type: "Text", Label: "ORDEN #", Source: "order.Number", Format: "Size2", Align: "Center" },
                            { Type: "Text", Label: "Fecha: ", Source: "order.Date", Align: "Center" },
                            { Type: "Line" }
                        ]
                    },
                    {
                        Name: "Items", Type: "Table", DataSource: "order.Items", Order: 3,
                        Elements: [
                            { Type: "Text", Label: "Item", Source: "Name", WidthPercentage: 80 },
                            { Type: "Text", Label: "Cant", Source: "Qty", WidthPercentage: 20 }
                        ]
                    },
                    {
                        Name: "Footer", Type: "Static", Order: 4,
                        Elements: [
                            { Type: "Line" },
                            { Type: "Text", Label: "Detalle: ", Source: "Detail", Format: "Italic", Align: "Left" }
                        ]
                    }
                ]
            }
        },
        factura1: {
            Action: "UpdateTemplate",
            Template: {
                DocumentType: "factura_electronica",
                Name: "Factura Clásica (Actualización)",
                Sections: [
                    {
                        Name: "SellerInfo", Type: "Static", Order: 1,
                        Elements: [
                            { Type: "Text", Source: "Seller.Name", Format: "Size1 Bold", Align: "Center" },
                            { Type: "Text", Label: "NIT: ", Source: "Seller.Nit", Align: "Center" },
                            { Type: "Line" }
                        ]
                    },
                    {
                        Name: "BuyerInfo", Type: "Static", Order: 2,
                        Elements: [
                            { Type: "Text", Label: "CLIENTE: ", Source: "Buyer.Name", Align: "Left" },
                            { Type: "Text", Label: "NIT/CC: ", Source: "Buyer.Nit", Align: "Left" },
                            { Type: "Line" }
                        ]
                    },
                    {
                        Name: "Items", Type: "Table", DataSource: "Invoice.Items", Order: 3,
                        Elements: [
                            { Type: "Text", Label: "Desc", Source: "Description", WidthPercentage: 50 },
                            { Type: "Text", Label: "Cant", Source: "Quantity", WidthPercentage: 20 },
                            { Type: "Text", Label: "Total", Source: "Total", WidthPercentage: 30, Align: "Right" }
                        ]
                    },
                    {
                        Name: "Totals", Type: "Static", Order: 4,
                        Elements: [
                            { Type: "Line" },
                            { Type: "Text", Label: "TOTAL A PAGAR: ", Source: "Invoice.Total", Format: "Size1 Bold", Align: "Right" }
                        ]
                    }
                ]
            }
        },
        factura2: {
            Action: "UpdateTemplate",
            Template: {
                DocumentType: "factura_electronica",
                Name: "Factura Moderna (Actualización)",
                Sections: [
                    {
                        Name: "LogoArea", Type: "Static", Order: 1,
                        Elements: [
                            { Type: "Text", Source: "Seller.Name", Align: "Right", Format: "Bold" },
                            { Type: "Text", StaticValue: "FACTURA ELECTRÓNICA DE VENTA", Align: "Left", Format: "Bold" },
                            { Type: "Text", Label: "No. ", Source: "Invoice.Number", Align: "Left" }
                        ]
                    },
                    {
                        Name: "MainContent", Type: "Static", Order: 2,
                        Elements: [
                            { Type: "Line" },
                            { Type: "Text", Label: "Fecha Emisión: ", Source: "Invoice.IssueDate", Align: "Left" }
                        ]
                    },
                    {
                        Name: "Items", Type: "Table", DataSource: "Invoice.Items", Order: 3,
                        Elements: [
                            { Type: "Text", Label: "Cod", Source: "Code", WidthPercentage: 25 },
                            { Type: "Text", Label: "Desc", Source: "Description", WidthPercentage: 45 },
                            { Type: "Text", Label: "Total", Source: "Total", WidthPercentage: 30, Align: "Right" }
                        ]
                    },
                    {
                        Name: "Financials", Type: "Static", Order: 4,
                        Elements: [
                            { Type: "Line" },
                            { Type: "Text", Label: "Subtotal: ", Source: "Invoice.Subtotal", Align: "Right" },
                            { Type: "Text", Label: "IVA: ", Source: "Invoice.Iva", Align: "Right" },
                            { Type: "Text", Label: "TOTAL: ", Source: "Invoice.Total", Align: "Right", Format: "Size1 Bold" }
                        ]
                    },
                    {
                        Name: "Legal", Type: "Static", Order: 5,
                        Elements: [
                            { Type: "QrCode", Source: "QrString", Size: 4, Align: "Center" },
                            { Type: "Text", Label: "CUFE: ", Source: "TechKey", Format: "FontB" }
                        ]
                    }
                ]
            }
        }
    };

    /**
     * Envía una solicitud de actualización de plantilla al APM.
     * 
     * NOTA IMPORTANTE PARA EL EQUIPO FRONTEND:
     * Para que la aplicación Android APM se ponga en primer plano y el usuario vea 
     * el diálogo de confirmación, es necesario disparar un "Deep Link": apm://update.
     * 
     * Este mecanismo es necesario porque Android restringe que los servicios en segundo 
     * plano (como el de APM) muestren interfaces visuales directamente si la app no está activa.
     */
    window.sendUpdateTemplate = function(templateKey) {
        const templateUpdate = updateTemplates[templateKey];
        if (templateUpdate) {
            // 1. Enviamos el mensaje WebSocket con la definición de la plantilla
            sendTestMessage(JSON.stringify(templateUpdate, null, 4));
            
            // 2. Detectar si el navegador está en Android
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            if (isAndroid) {
                // 3. Forzar el salto a la aplicación APM usando el esquema personalizado (Deep Link)
                // Usamos un pequeño delay para asegurar la consistencia del envío previo por socket.
                setTimeout(() => {
                    console.log("Acción en Android: Saltando a la app APM (apm://update)");
                    window.location.href = "apm://update";
                }, 150);
            } else {
                logMessage('Actualización enviada (Desktop). Se mostrará diálogo de confirmación en Windows.', 'info');
            }
        } else {
            logMessage('Error: No se encontró la plantilla: ' + templateKey, 'error');
        }
    };

    window.openTab = function(tabName) {
        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach(btn => btn.classList.remove('active'));
        const clickedBtn = Array.from(buttons).find(b => b.dataset.tab === tabName);
        if(clickedBtn) clickedBtn.classList.add('active');
        
        const contents = document.querySelectorAll('.tab-content');
        contents.forEach(content => content.classList.remove('active'));
        
        const selectedId = 'payload' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
        document.getElementById(selectedId).classList.add('active');
        activePayloadId = selectedId;
    };

    document.addEventListener('DOMContentLoaded', () => {
        connectWebSocket();
        document.getElementById('payloadTicket').value = JSON.stringify(templates.ticket, null, 4);
        document.getElementById('payloadComanda').value = JSON.stringify(templates.comanda, null, 4);
        document.getElementById('payloadFactura').value = JSON.stringify(templates.factura, null, 4);
        document.getElementById('payloadSticker').value = JSON.stringify(templates.sticker, null, 4);

        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => button.addEventListener('click', () => window.openTab(button.dataset.tab)));
        
        document.getElementById('sendPayloadButton').addEventListener('click', () => {
            const payload = document.getElementById(activePayloadId).value;
            sendTestMessage(payload);
        });

        document.getElementById('reconnectButton').addEventListener('click', reconnectWebSocket);
        document.getElementById('addInvoiceRowBtn').addEventListener('click', addInvoiceRow);

        document.getElementById('toggleListeningButton').addEventListener('click', () => {
             const btn = document.getElementById('toggleListeningButton');
             const isListening = btn.textContent !== "Empezar a Escuchar";
             if (!isListening) {
                 sendTestMessage(JSON.stringify({ Action: "StartListening", ScaleId: document.getElementById('scaleIdInput').value }));
                 btn.textContent = "Dejar de Escuchar";
                 btn.style.backgroundColor = "#d9534f";
             } else {
                 sendTestMessage(JSON.stringify({ Action: "StopListening" }));
                 btn.textContent = "Empezar a Escuchar";
                 btn.style.backgroundColor = "#4CAF50";
             }
        });

        window.openTab('ticket');
        addInvoiceRow();
    });

    function addInvoiceRow() {
        const tbody = document.querySelector('#invoiceTable tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="row-input code" placeholder="1001"></td>
            <td><input type="text" class="row-input desc" readonly></td>
            <td><input type="number" class="row-input qty" placeholder="0.000"></td>
            <td><input type="number" class="row-input price" readonly></td>
            <td><input type="number" class="row-input total" readonly></td>
            <td><button onclick="this.closest('tr').remove()" style="color:red;">X</button></td>
        `;

        const codeInput = tr.querySelector('.code');
        const qtyInput = tr.querySelector('.qty');

        codeInput.addEventListener('change', (e) => {
            const product = productsDb[e.target.value];
            if (product) {
                tr.querySelector('.desc').value = product.description;
                tr.querySelector('.price').value = product.price;
                calculateRowTotal(tr);
                qtyInput.focus();
            } else {
                alert('No encontrado');
            }
        });

        qtyInput.addEventListener('focus', () => {
            activeQuantityInput = qtyInput;
            sendTestMessage(JSON.stringify({ Action: "StartListening", ScaleId: document.getElementById('scaleIdInput').value }));
        });

        qtyInput.addEventListener('blur', () => {
            activeQuantityInput = null;
            sendTestMessage(JSON.stringify({ Action: "StopListening" }));
        });

        qtyInput.addEventListener('input', () => calculateRowTotal(tr));
        tbody.appendChild(tr);
    }

    function calculateRowTotal(row) {
        const qty = parseFloat(row.querySelector('.qty').value) || 0;
        const price = parseFloat(row.querySelector('.price').value) || 0;
        row.querySelector('.total').value = (qty * price).toFixed(2);
    }
    </script>
</body>
</html>
