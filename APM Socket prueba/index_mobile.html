<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Conexión APM WebSocket - Móvil</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        #status { font-weight: bold; margin-top: 10px; }
        #messages { border: 1px solid #ccc; padding: 10px; min-height: 150px; overflow-y: scroll; margin-top: 20px; background-color: #f9f9f9; }
        .log-info { color: blue; }
        .log-success { color: green; }
        .log-error { color: red; }
        .log-warning { color: orange; }
        
        /* Estilos para las pestañas */
        .tab-container { margin-top: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; background-color: #ddd; border: none; outline: none; font-weight: bold; }
        .tab-button.active { background-color: #333; color: white; }
        .tab-content { display: none; width: 100%; box-sizing: border-box; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <h1>Cliente de Prueba APM WebSocket - Versión Móvil</h1>
    <p>Estado de la conexión: <span id="status">Desconectado</span></p>
    <button id="reconnectButton" style="margin-top: 10px; padding: 5px 10px;">Reconectar</button>
    <p>Mensajes del Cliente:</p>
    <div id="messages"></div>

    <h2>Enviar Mensaje de Prueba (PrintJobRequest)</h2>
    
    <div class="tab-container">
        <button class="tab-button" data-tab="ticket">Ticket Venta</button>
        <button class="tab-button" data-tab="comanda">Comanda</button>
        <button class="tab-button" data-tab="factura">Factura Electrónica</button>
        <button class="tab-button" data-tab="sticker">Sticker Códigos</button>
    </div>

    <div style="margin-top: 10px;">
        <textarea id="payloadTicket" class="tab-content" rows="15" cols="80"></textarea>
        <textarea id="payloadComanda" class="tab-content" rows="15" cols="80"></textarea>
        <textarea id="payloadFactura" class="tab-content" rows="15" cols="80"></textarea>
        <textarea id="payloadSticker" class="tab-content" rows="15" cols="80"></textarea>
    </div>

    <button id="sendPayloadButton" style="margin-top: 10px; padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; cursor: pointer;">Enviar JSON Seleccionado</button>

    <script>
        // Script incrustado para probar la conexión WebSocket al APM
        // Este archivo funciona sin necesidad de referencias externas

        const websocketUrl = 'ws://localhost:7000/websocket/';
        let socket;
        const statusSpan = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        let activePayloadId = 'payloadTicket';

        function logMessage(message, type = 'info') {
            const p = document.createElement('p');
            p.className = `log-${type}`;
            p.textContent = message;
            messagesDiv.appendChild(p);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function connectWebSocket() {
            if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
                logMessage('Ya existe una conexión WebSocket activa o en proceso. No se intentará una nueva conexión.', 'warning');
                return;
            }

            statusSpan.textContent = 'Intentando conectar...';
            statusSpan.style.color = 'orange';
            logMessage('Intentando establecer conexión WebSocket con: ' + websocketUrl, 'info');

            try {
                socket = new WebSocket(websocketUrl);

                socket.onopen = (event) => {
                    statusSpan.textContent = 'Conectado';
                    statusSpan.style.color = 'green';
                    logMessage('Conexión WebSocket establecida con el servidor APM.', 'success');
                    console.log('WebSocket connection established:', event);
                };

                socket.onmessage = (event) => {
                    logMessage('Mensaje recibido del servidor: ' + event.data);
                    console.log('Message from server:', event.data);
                };

                socket.onclose = (event) => {
                    statusSpan.textContent = 'Desconectado';
                    statusSpan.style.color = 'red';
                    let reason = event.reason || 'Conexión cerrada inesperadamente.';
                    if (event.wasClean) {
                        logMessage(`Conexión WebSocket cerrada limpiamente. Código: ${event.code}, Razón: ${reason}`, 'info');
                    } else {
                        logMessage(`Conexión WebSocket cerrada abruptamente. Código: ${event.code}, Razón: ${reason}`, 'error');
                    }
                    console.log('WebSocket connection closed:', event);
                    socket = null;
                };

                socket.onerror = (error) => {
                    statusSpan.textContent = 'Error';
                    statusSpan.style.color = 'red';
                    logMessage('Error en la conexión WebSocket. Consulta la consola del navegador para más detalles.', 'error');
                    console.error('WebSocket Error:', error);
                };

            } catch (error) {
                logMessage('Error al intentar crear el objeto WebSocket: ' + error.message, 'error');
                console.error('Error creating WebSocket object:', error);
            }
        }

        function reconnectWebSocket() {
            if (socket) {
                if (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING) {
                    logMessage('Cerrando conexión WebSocket existente antes de reconectar...', 'info');
                    socket.close(1000, 'Reconexión solicitada por el usuario');
                } else {
                    logMessage('No hay conexión WebSocket abierta para cerrar, intentando conectar directamente.', 'info');
                    connectWebSocket();
                }
            } else {
                connectWebSocket();
            }
        }

        function sendTestMessage(message) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(message);
                logMessage('Mensaje enviado al servidor: ' + message, 'info');
            } else {
                logMessage('No hay conexión WebSocket abierta para enviar mensajes.', 'warning');
            }
        }

        const templates = {
            ticket: {
                "JobId": "TICKET-001",
                "StationId": "CAJA_1",
                "PrinterId": "printHambuger",
                "DocumentType": "ticket_venta",
                "Document": {
                    "company": { "Name": "Supermercado Demo", "Nit": "900123456", "Address": "Calle Principal #123", "Phone": "555-1234" },
                    "sale": { 
                        "Number": "FV-1001", 
                        "Date": new Date().toISOString(), 
                        "Items": [
                            { "Name": "Leche Entera", "Qty": 2, "UnitPrice": 2500, "Total": 5000 },
                            { "Name": "Pan Tajado", "Qty": 1, "UnitPrice": 3500, "Total": 3500 }
                        ],
                        "Subtotal": 8500,
                        "iva": 0,
                        "Total": 8500
                    },
                    "footer": ["Gracias por su compra"]
                }
            },
            comanda: {
                "JobId": "CMD-001",
                "StationId": "COCINA",
                "PrinterId": "printHambuger",
                "DocumentType": "comanda",
                "Document": {
                    "order": { 
                        "Number": "CMD-001",
                        "Table": "Mesa 5", 
                        "Waiter": "Carlos", 
                        "Date": new Date().toISOString(),
                        "RestaurantName": "Restaurant Tremendo Chuzo",
                        "Items": [
                            { "Name": "Hamburguesa Doble", "Qty": 1, "Notes": "Sin cebolla" },
                            { "Name": "Papas Fritas", "Qty": 1, "Notes": "Extra crocantes" },
                            { "Name": "Gaseosa", "Qty": 2, "Notes": "" }
                        ],
                        "GeneratedDate": new Date().toISOString(),
                        "CreatedBy": "Jose Reyes"
                    },
                    "Detail": "Todoterreno sin piña, full arepa sin maíz y la salchipapa sin lechuga"
                }
            },
            factura: {
                "JobId": "FE-2025",
                "StationId": "ADMIN",
                "PrinterId": "printHambuger",
                "DocumentType": "factura_electronica",
                "Document": {
                    "header": { "Title": "FACTURA ELECTRÓNICA DE VENTA", "Number": "FE-2025" },
                    "customer": { "Name": "Empresa Cliente S.A.S", "Nit": "800.111.222-3", "Address": "Av. Empresarial 55" },
                    "totals": { "Subtotal": 100000, "Tax": 19000, "Total": 119000 },
                    "cufe": "abc1234567890def..."
                }
            },
            sticker: {
                "JobId": "STICKER-001",
                "StationId": "ALMACEN",
                "PrinterId": "printHambuger",
                "DocumentType": "sticker_codigo_barras",
                "Document": {
                    "stickers": [
                        {
                            "ProductName": "Manzana Roja",
                            "ProductCode": "MZN-001",
                            "BarcodeValue": "1234567890128",
                            "BarcodeType": "EAN13"
                        },
                        {
                            "ProductName": "Pera Verde",
                            "ProductCode": "PER-002",
                            "BarcodeValue": "0987654321093",
                            "BarcodeType": "EAN13"
                        },
                        {
                            "ProductName": "Uvas Importadas",
                            "ProductCode": "UVA-003",
                            "BarcodeValue": "9876543210987",
                            "BarcodeType": "EAN13"
                        },
                        {
                            "ProductName": "Banano Nacional",
                            "ProductCode": "BAN-004",
                            "BarcodeValue": "1122334455667",
                            "BarcodeType": "EAN13"
                        }
                    ]
                }
            }
        };

        window.openTab = function(tabName) {
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            const clickedBtn = Array.from(buttons).find(b => b.dataset.tab === tabName);
            if(clickedBtn) clickedBtn.classList.add('active');
            
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            const selectedId = 'payload' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            document.getElementById(selectedId).classList.add('active');
            activePayloadId = selectedId;
        };

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Content Loaded. Inicializando cliente WebSocket.");
            connectWebSocket();

            document.getElementById('payloadTicket').value = JSON.stringify(templates.ticket, null, 4);
            document.getElementById('payloadComanda').value = JSON.stringify(templates.comanda, null, 4);
            document.getElementById('payloadFactura').value = JSON.stringify(templates.factura, null, 4);
            document.getElementById('payloadSticker').value = JSON.stringify(templates.sticker, null, 4);

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    window.openTab(button.dataset.tab);
                });
            });

            const sendPayloadButton = document.getElementById('sendPayloadButton');
            const reconnectButton = document.getElementById('reconnectButton');

            if (sendPayloadButton) {
                sendPayloadButton.addEventListener('click', (event) => {
                    event.preventDefault();
                    const activeTextarea = document.getElementById(activePayloadId);
                    if (activeTextarea) {
                        const payload = activeTextarea.value;
                        sendTestMessage(payload);
                    } else {
                        logMessage('Error: No se encontró el área de texto activa.', 'error');
                    }
                });
            }

            if (reconnectButton) {
                reconnectButton.addEventListener('click', reconnectWebSocket);
            }

            logMessage('Cliente listo. Prueba las pestañas para ver los diferentes JSONs.', 'success');
            window.openTab('ticket');
        });
    </script>
</body>
</html>
